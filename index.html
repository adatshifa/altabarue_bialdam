<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة شفاء للتبرع بالدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488;
            --secondary-color: #f43f5e;
            --bg-body: #f0fdfa;
        }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-body); color: #1f2937; }
        .urgent { border-right: 5px solid var(--secondary-color); }
        .soon { border-right: 5px solid #f59e0b; }
        .later { border-right: 5px solid #10b981; }
        .verified::after { content: '✅'; font-size: 1.2rem; margin-right: 10px; vertical-align: middle; }
        .custom-shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07); }
        .modal { transition: opacity 0.25s ease; }
        .modal-container, .modal-content { transition: transform 0.25s ease, opacity 0.25s ease; animation: scaleIn 0.3s ease-out; }
        .side-bar { transition: transform 0.3s ease-in-out; }
        .overlay.active { opacity: 1; visibility: visible; }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .new-request-highlight { animation: highlight-fade 5s ease-out; }
        @keyframes highlight-fade {
            0% { background-color: rgba(16, 185, 129, 0.2); }
            100% { background-color: transparent; }
        }
        .unseen-request {
            border-left: 5px solid var(--primary-color);
            background-color: #f0fdfa;
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: left 0.75rem center;
            background-size: 1.25em;
            padding-right: 1rem;
        }
        .vote-btn.voted-like { color: var(--primary-color); }
        .vote-btn.voted-dislike { color: var(--secondary-color); }
    </style>
</head>
<body class="antialiased">

    <div id="sound-activation-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[10000]">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-2xl p-8 text-center max-w-lg w-full border-t-4 border-teal-500">
            <i class="fas fa-volume-up text-6xl text-teal-400 mb-5"></i>
            <h2 class="text-3xl font-extrabold text-white mb-4">تفعيل الإشعارات الصوتية</h2>
            <p class="text-gray-300 mb-8">لضمان عدم تفويت أي طلب تبرع عاجل، نوصي بتفعيل الصوت.</p>
            <button id="activate-sound-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold text-xl py-3 px-10 rounded-lg transition-transform transform hover:scale-105">
                <i class="fas fa-check-circle mr-2"></i> نعم، قم بالتفعيل
            </button>
        </div>
    </div>
    
    <div id="new-request-alert-modal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-[9999]">
        <div class="modal-content bg-red-800 rounded-2xl shadow-2xl p-6 md:p-8 text-center max-w-lg w-full border-t-4 border-yellow-300">
            <i class="fas fa-bell text-5xl md:text-6xl text-yellow-300 animate-bounce mb-5"></i>
            <h2 id="new-request-modal-title" class="text-3xl md:text-4xl font-extrabold text-white mb-4">حالة عاجلة جديدة!</h2>
            <div id="modal-request-details" class="bg-red-900/50 p-4 rounded-lg mb-8 text-right space-y-3"></div>
            <button id="modal-confirm-btn" class="bg-yellow-400 hover:bg-yellow-500 text-red-900 font-bold text-lg md:text-xl py-3 px-10 rounded-lg transition-transform transform hover:scale-105">
                <i class="fas fa-check-circle mr-2"></i> حسناً
            </button>
        </div>
    </div>
    
    <audio id="notification-sound" src="https://firebasestorage.googleapis.com/v0/b/altabarue-bialdam.appspot.com/o/alerta.mp3?alt=media&token=c1c73a87-4a00-474c-83b5-7c9898246e7f" preload="auto" loop></audio>

    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 invisible transition-opacity duration-300"></div>

    <header class="bg-white/80 backdrop-blur-md custom-shadow-lg fixed top-0 right-0 left-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-3xl font-extrabold text-teal-600">أداة شفاء</a>
            <div class="flex items-center gap-2">
                <button id="mute-btn" title="كتم صوت الإشعارات" class="text-gray-500 hover:text-gray-800 transition-colors w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-100">
                    <i id="mute-icon" class="fas fa-volume-up"></i>
                </button>
                <button id="menu-btn" class="fas fa-bars text-xl text-gray-600 cursor-pointer h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
            </div>
        </div>
    </header>
    
    <aside id="side-bar" class="side-bar fixed top-0 -right-full w-80 h-full bg-white shadow-lg z-50 p-6 flex flex-col transform">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-teal-600">القائمة</h2>
            <button id="close-btn" class="fas fa-times text-2xl text-gray-500 cursor-pointer w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
        </div>

        <nav class="flex-grow flex flex-col gap-3">
            <a href="donate.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-hand-holding-heart text-teal-500 w-6 text-center"></i><span>أريد التبرع</span></a>
            <a href="requests.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-list-alt text-teal-500 w-6 text-center"></i><span>تصفح الطلبات</span></a>
            <a href="centers.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-hospital text-teal-500 w-6 text-center"></i><span>أماكن التبرع</span></a>
            <a href="suggestions.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-lightbulb text-teal-500 w-6 text-center"></i><span>اقتراحاتكم</span></a>
            <a href="why-donate.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-question-circle text-teal-500 w-6 text-center"></i><span>لماذا علينا التبرع؟</span></a>
            <a href="contact.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-paper-plane text-teal-500 w-6 text-center"></i><span>تواصل معنا</span></a>
        </nav>

        <div>
            <div class="border-t border-gray-200 my-4"></div>
            <button id="admin-login-btn" class="w-full flex items-center gap-4 p-4 rounded-lg text-lg font-semibold bg-gray-100 hover:bg-gray-200 transition-colors text-gray-700">
                <i class="fas fa-user-shield text-gray-600 w-6 text-center"></i>
                <span>خاص بالمشرفين</span>
            </button>
        </div>
    </aside>
    <main class="container mx-auto px-4 sm:px-6 pt-24 sm:pt-28">
         <section class="text-center py-16 md:py-24">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mb-4 leading-tight">قطرة دم منك، حياة لغيرك</h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-10">منصة شفاء تربط بين المتبرعين بالدم والمحتاجين إليه بسهولة وسرعة. كن سبباً في إنقاذ حياة.</p>
         <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <a href="donate.html" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-hand-holding-heart mr-2"></i> أريد التبرع
                </a>
                <button id="open-request-modal-btn" class="w-full sm:w-auto bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-bullhorn mr-2"></i> الإبلاغ عن حالة
                </button>
                <a href="suggestions.html" class="w-full sm:w-auto bg-gray-700 hover:bg-gray-800 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-lightbulb mr-2"></i> اقتراحاتكم
                </a>
            </div>
        </section>

        <section class="pt-20 pb-10">
            <div class="flex justify-between items-center mb-8">
                 <h2 class="text-3xl md:text-4xl font-bold text-gray-800">أحدث الحالات</h2>
                 <a href="requests.html" class="bg-white hover:bg-gray-100 text-teal-600 font-bold py-2 px-5 rounded-full transition shadow-md hover:shadow-lg">
                    عرض الكل <i class="fas fa-arrow-left mr-2"></i>
                </a>
            </div>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </section>
    </main>
    
    <div id="request-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4 bg-black/60 overflow-y-auto">
        <div class="modal-container bg-white w-full max-w-lg rounded-xl shadow-2xl relative my-8">
            <button class="close-modal-btn absolute top-4 left-4 text-gray-500 hover:text-gray-800 text-2xl z-10">&times;</button>
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6">الإبلاغ عن حالة جديدة</h2>
                <form id="request-form" class="space-y-5">
                    
                    <div>
                        <label for="bloodType-select" class="font-semibold mb-2 block">فصيلة الدم المطلوبة <span class="text-red-500">*</span></label>
                        <select name="bloodType" id="bloodType-select" class="w-full p-3 border rounded-lg bg-white" required>
                            <option value="" disabled selected>-- اختر فصيلة الدم --</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <input type="text" name="hospital" placeholder="اسم المستشفى" class="w-full p-3 border rounded-lg" required>
                    <input type="text" name="wilaya" placeholder="الولاية" class="w-full p-3 border rounded-lg" required>
                    <input type="text" name="location" placeholder="البلدية أو مكان قريب" class="w-full p-3 border rounded-lg" required>
                    <input type="tel" name="phone1" placeholder="رقم الهاتف" class="w-full p-3 border rounded-lg" required>
                    <textarea name="details" placeholder="تفاصيل إضافية (اختياري)" class="w-full p-3 border rounded-lg h-24"></textarea>

                    <button type="submit" id="submit-request-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">إرسال الطلب</button>
                </form>
            </div>
        </div>
    </div>
     
    <div id="report-reason-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4 bg-black/60">
        <div class="modal-container bg-white w-full max-w-lg rounded-xl shadow-2xl relative my-8">
            <button class="close-modal-btn absolute top-4 left-4 text-gray-500 hover:text-gray-800 text-2xl z-10">&times;</button>
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6">الإبلاغ عن هذا الطلب</h2>
                <form id="report-reason-form" class="space-y-4">
                    <input type="hidden" id="report-request-id" name="requestId">
                    <div>
                        <label for="report-reason" class="font-semibold mb-2 block">ما هو سبب بلاغك؟ <span class="text-red-500">*</span></label>
                        <textarea id="report-reason" name="reason" placeholder="مثال: الرقم غير صحيح، الحالة لم تعد بحاجة لمتبرعين، معلومات خاطئة..." class="w-full p-3 border rounded-lg h-32" required></textarea>
                    </div>
                    <button type="submit" id="submit-report-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">إرسال البلاغ</button>
                </form>
            </div>
        </div>
    </div>

    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4 bg-black/60">
         <div class="modal-container bg-white w-full max-w-sm rounded-xl shadow-2xl p-8 text-center">
            <i id="message-icon" class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
            <p id="message-text" class="text-lg mb-6">تم إرسال بلاغك بنجاح. شكرًا لك.</p>
            <button class="close-modal-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-8 rounded-lg">حسنًا</button>
        </div>
    </div>

    <div id="admin-password-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4 bg-black/60">
        <div class="modal-container bg-white w-full max-w-sm rounded-xl shadow-2xl relative my-8">
            <button class="close-modal-btn absolute top-4 left-4 text-gray-500 hover:text-gray-800 text-2xl z-10">&times;</button>
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6">دخول المشرفين</h2>
                <form id="admin-password-form" class="space-y-4">
                    <div>
                        <label for="admin-password" class="font-semibold mb-2 block">الرجاء إدخال كلمة السر</label>
                        <div class="relative">
                            <input type="password" id="admin-password" name="password" class="w-full p-3 border rounded-lg text-center pl-12" required>
                            <button type="button" id="toggle-admin-password" title="إظهار/إخفاء كلمة السر" class="absolute top-1/2 left-4 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p id="admin-password-error" class="text-red-500 text-sm mt-2 text-center hidden">كلمة السر غير صحيحة.</p>
                    </div>
                    <button type="submit" id="submit-admin-password-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">دخول</button>
                </form>
            </div>
        </div>
    </div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, increment, arrayUnion, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBjGbfd-myjqLtqvdMp4b-h4LIaeZjfUto",
      authDomain: "altabarue-bialdam.firebaseapp.com",
      databaseURL: "https://altabarue-bialdam-default-rtdb.firebaseio.com",
      projectId: "altabarue-bialdam",
      storageBucket: "altabarue-bialdam.appspot.com",
      messagingSenderId: "1032387539358",
      appId: "1:1032387539358:web:229d33a9d5a0f522c9268f",
      measurementId: "G-GQ6M7F21PZ"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // --- START: NOTIFICATION SYSTEM LOGIC ---
    let newRequestCount = 0;
    let originalTitle = document.title;
    let titleInterval = null;
    let isInitialLoad = true;
    let knownRequestIds = new Set();
    const audioManager = {
        element: document.getElementById('notification-sound'), isMuted: false, isUnlocked: false,
        unlock() { if (this.isUnlocked) return; this.element.play().then(() => this.element.pause()).catch(e => {}); this.isUnlocked = true; },
        play() { if (this.isMuted || !this.isUnlocked) return; this.element.loop = true; this.element.play().catch(e => console.error("Audio play failed:", e)); },
        stop() { this.element.pause(); this.element.currentTime = 0; },
        toggleMute() { this.isMuted = !this.isMuted; document.getElementById('mute-icon').className = this.isMuted ? 'fas fa-volume-mute text-red-500' : 'fas fa-volume-up'; document.getElementById('mute-btn').title = this.isMuted ? 'تشغيل صوت الإشعارات' : 'كتم صوت الإشعارات'; if (this.isMuted) this.stop(); }
    };
    function setupSoundActivation() {
        const soundModal = document.getElementById('sound-activation-modal');
        if (localStorage.getItem('soundActivated') === 'true') { audioManager.isUnlocked = true; return; }
        soundModal.classList.remove('hidden');
        document.getElementById('activate-sound-btn').onclick = () => { audioManager.unlock(); localStorage.setItem('soundActivated', 'true'); soundModal.classList.add('hidden'); };
    }
    const newRequestModal = document.getElementById('new-request-alert-modal');
    document.getElementById('modal-confirm-btn').onclick = hideNewRequestAlert;
    function flashTitle() { if (newRequestCount > 0) { document.title = document.title === originalTitle ? `(${newRequestCount}) حالة جديدة!` : originalTitle; } else { clearInterval(titleInterval); titleInterval = null; document.title = originalTitle; } }
    window.onfocus = () => { newRequestCount = 0; flashTitle(); };
    function showNewRequestAlert(request, count) {
        const titleEl = document.getElementById('new-request-modal-title');
        titleEl.textContent = count > 1 ? `(${count}) حالات عاجلة جديدة!` : 'حالة عاجلة جديدة!';
        document.getElementById('modal-request-details').innerHTML = `<div class="flex justify-between items-center text-lg"><span class="text-gray-200">المستشفى:</span><span class="font-bold text-white">${request.hospital}</span></div><div class="flex justify-between items-center text-lg"><span class="text-gray-200">الولاية:</span><span class="font-bold text-white">${request.wilaya}</span></div><div class="flex justify-between items-center text-2xl mt-2 pt-2 border-t border-red-700"><span class="text-gray-200">الفصيلة:</span><span class="font-extrabold text-yellow-300">${request.bloodType}</span></div>`;
        newRequestModal.classList.remove('hidden');
        audioManager.play();
        newRequestCount += count;
        if (!titleInterval) { titleInterval = setInterval(flashTitle, 1000); }
    }
    function hideNewRequestAlert() { newRequestModal.classList.add('hidden'); audioManager.stop(); }
    document.getElementById('mute-btn').onclick = () => audioManager.toggleMute();
    // --- END: NOTIFICATION SYSTEM LOGIC ---

    // =================================================================
    // =========== START: UNIFIED VOTING LOGIC (FINAL SOLUTION) ========
    // =================================================================
    const votesManager = {
        votes: JSON.parse(localStorage.getItem('shifaa-votes')) || {},
        getVote(requestId) { return this.votes[requestId]; },
        setVote(requestId, voteType) {
            if (voteType === null) {
                delete this.votes[requestId];
            } else {
                this.votes[requestId] = voteType;
            }
            localStorage.setItem('shifaa-votes', JSON.stringify(this.votes));
        },
        updateCardUI(cardElement) {
            const likeBtn = cardElement.querySelector('[data-vote="like"]');
            if (!likeBtn) return;
            const dislikeBtn = cardElement.querySelector('[data-vote="dislike"]');
            const requestId = likeBtn.dataset.id;
            const userVote = this.getVote(requestId);

            likeBtn.classList.remove('voted-like');
            dislikeBtn.classList.remove('voted-dislike');

            if (userVote === 'like') {
                likeBtn.classList.add('voted-like');
            } else if (userVote === 'dislike') {
                dislikeBtn.classList.add('voted-dislike');
            }
        }
    };

    async function handleVote(requestId, voteType) {
        const docRef = doc(db, 'donation_requests', requestId);
        const currentVote = votesManager.getVote(requestId);
        if (currentVote === voteType) return;
        
        votesManager.setVote(requestId, voteType);
        const cardElement = document.querySelector(`.vote-btn[data-id="${requestId}"]`).closest('.bg-white');
        if (cardElement) {
           votesManager.updateCardUI(cardElement);
        }
        const updates = {};
        updates[`${voteType}s`] = increment(1);
        
        if (currentVote) {
            const oppositeVoteType = currentVote === 'like' ? 'dislikes' : 'likes';
            updates[oppositeVoteType] = increment(-1);
        }
        
        try {
            await updateDoc(docRef, updates);
        } catch (error) {
            console.error("Error processing vote: ", error);
            votesManager.setVote(requestId, currentVote); 
             if (cardElement) {
                votesManager.updateCardUI(cardElement);
             }
             alert("حدث خطأ أثناء تسجيل تصويتك. الرجاء المحاولة مرة أخرى.");
        }
    }
    // =================================================================
    // =========== END: UNIFIED VOTING LOGIC (FINAL SOLUTION) ==========
    // =================================================================

    // --- FIREBASE & DATA DISPLAY LOGIC ---
    const dashboard = document.getElementById('dashboard');
    const getTimeAgo = (date) => {
        const seconds = Math.floor((new Date() - date) / 1000); let interval = seconds / 31536000;
        if (interval > 1) return `قبل ${Math.floor(interval)} سنة`; interval = seconds / 2592000;
        if (interval > 1) return `قبل ${Math.floor(interval)} شهر`; interval = seconds / 86400;
        if (interval > 1) return `قبل ${Math.floor(interval)} يوم`; interval = seconds / 3600;
        if (interval > 1) return `قبل ${Math.floor(interval)} ساعة`; interval = seconds / 60;
        if (interval > 1) return `قبل ${Math.floor(interval)} دقيقة`; return "قبل لحظات";
    };
    
    // ============= MODIFIED FUNCTION ===============
    const createCardHTML = (doc) => {
        const requestData = { id: doc.id, ...doc.data() };
        const requestDate = requestData.createdAt ? requestData.createdAt.toDate() : new Date();
        
        return `
            <div class="flex flex-col bg-white p-5 rounded-xl custom-shadow-lg transition duration-300 transform hover:-translate-y-1 ${requestData.urgency}">
                <div class="flex-grow">
                    <div class="flex justify-between items-start gap-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 ${requestData.verified ? 'verified' : ''}">${requestData.hospital}</h3>
                            <p class="text-gray-600">${requestData.wilaya}, ${requestData.location}</p>
                        </div>
                        <div class="bg-rose-500 text-white font-bold text-2xl p-2 rounded-full w-16 h-16 flex items-center justify-center shadow-lg flex-shrink-0">${requestData.bloodType}</div>
                    </div>
                    <div class="my-4 border-t pt-4">
                        <p class="flex items-center gap-2 text-lg" dir="ltr"><i class="fas fa-phone text-gray-400"></i><a href="tel:${requestData.phone1}" class="text-blue-600 hover:underline tracking-wider">${requestData.phone1}</a></p>
                    </div>
                </div>
                <div class="flex justify-between items-center text-sm text-gray-500 pt-3 border-t">
                    <p class="flex items-center gap-2" data-timestamp="${requestDate.toISOString()}"><i class="fas fa-clock"></i><span>${getTimeAgo(requestDate)}</span></p>
                    <div class="flex items-center gap-3">
                        <button data-id="${requestData.id}" data-vote="like" class="vote-btn text-gray-500 hover:text-green-600 transition">
                            <i class="fas fa-thumbs-up"></i> <span class="like-count font-semibold">${requestData.likes || 0}</span>
                        </button>
                        <button data-id="${requestData.id}" data-vote="dislike" class="vote-btn text-gray-500 hover:text-red-600 transition">
                            <i class="fas fa-thumbs-down"></i> <span class="dislike-count font-semibold">${requestData.dislikes || 0}</span>
                        </button>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-4 pt-3 border-t">
                     <button data-id="${requestData.id}" class="report-btn bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-1 px-3 rounded-lg transition text-xs">
                        <i class="fas fa-flag"></i> إبلاغ
                    </button>
                    <a href="request-details.html?id=${requestData.id}" class="bg-teal-50 hover:bg-teal-100 text-teal-800 font-bold py-1 px-4 rounded-lg transition text-xs flex items-center gap-1">
                        <i class="fas fa-eye"></i> عرض التفاصيل
                    </a>
                </div>
            </div>`;
    };

    const fetchAndDisplayRequests = () => {
        const q = query(collection(db, 'donation_requests'), orderBy('createdAt', 'desc'), limit(6));
        onSnapshot(q, (snapshot) => {
             const newRequests = [];
            if (isInitialLoad) {
                snapshot.docs.forEach(doc => knownRequestIds.add(doc.id));
                isInitialLoad = false;
            } else {
                 snapshot.docChanges().forEach(change => {
                    if (change.type === 'added' && !knownRequestIds.has(change.doc.id)) {
                        newRequests.push({ id: change.doc.id, ...change.doc.data() });
                        knownRequestIds.add(change.doc.id);
                    }
                });
            }

            dashboard.innerHTML = '';
            if (snapshot.empty) { 
                dashboard.innerHTML = `<div class="text-center p-10 bg-white rounded-xl custom-shadow-lg md:col-span-3"><p class="text-gray-500 text-xl">لا توجد حالات حالياً.</p></div>`; 
                return; 
            }
            
            snapshot.docs.forEach(doc => {
                const cardHTML = createCardHTML(doc);
                const cardElement = document.createElement('div');
                cardElement.innerHTML = cardHTML.trim();
                const newCard = cardElement.firstChild;
                dashboard.appendChild(newCard);
                votesManager.updateCardUI(newCard);
            });

            if (newRequests.length > 0) {
                showNewRequestAlert(newRequests[0], newRequests.length);
            }
            localStorage.setItem('lastVisitTimestamp', Date.now().toString());
        });
    };
    
    const updateTimestamps = () => {
        document.querySelectorAll('[data-timestamp]').forEach(el => {
            const date = new Date(el.dataset.timestamp);
            el.querySelector('span').textContent = getTimeAgo(date);
        });
    };

    // --- UI LOGIC ---
    const menuBtn = document.getElementById('menu-btn');
    const closeBtn = document.getElementById('close-btn');
    const sideBar = document.getElementById('side-bar');
    const overlay = document.getElementById('overlay');
    const openRequestModalBtn = document.getElementById('open-request-modal-btn');
    const requestModal = document.getElementById('request-modal');
    const messageModal = document.getElementById('message-modal');
    const requestForm = document.getElementById('request-form');
    const reportReasonModal = document.getElementById('report-reason-modal');
    const reportReasonForm = document.getElementById('report-reason-form');
    const reportRequestIdInput = document.getElementById('report-request-id');
    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminPasswordModal = document.getElementById('admin-password-modal');
    const adminPasswordForm = document.getElementById('admin-password-form');
    const adminPasswordInput = document.getElementById('admin-password');
    const adminPasswordError = document.getElementById('admin-password-error');
    const toggleAdminPasswordBtn = document.getElementById('toggle-admin-password');
    const toggleMenu = () => {
        sideBar.classList.toggle('-right-full'); sideBar.classList.toggle('right-0');
        overlay.classList.toggle('active');
    };
    const toggleModal = (modal) => modal.classList.toggle('hidden');
    menuBtn.addEventListener('click', toggleMenu);
    closeBtn.addEventListener('click', toggleMenu);
    overlay.addEventListener('click', toggleMenu);
    openRequestModalBtn.addEventListener('click', () => toggleModal(requestModal));
    requestForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-request-btn');
        if (submitBtn.disabled) return;
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الإرسال...';
        const formData = new FormData(requestForm);
        const data = {
            bloodType: formData.get('bloodType'), hospital: formData.get('hospital'),
            wilaya: formData.get('wilaya'), location: formData.get('location'),
            phone1: formData.get('phone1'), details: formData.get('details'),
            urgency: 'urgent', verified: false, reports: 0,
            likes: 0, dislikes: 0, createdAt: serverTimestamp()
        };
        try {
            await addDoc(collection(db, "donation_requests"), data);
            toggleModal(requestModal);
            requestForm.reset();
            document.getElementById('message-text').textContent = 'تم إضافة طلبك بنجاح!';
            document.getElementById('message-icon').className = 'fas fa-check-circle text-5xl text-green-500 mb-4';
            toggleModal(messageModal);
        } catch (error) {
            console.error("Error adding document: ", error);
            alert('حدث خطأ أثناء إرسال الطلب. الرجاء المحاولة مرة أخرى.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'إرسال الطلب';
        }
    });
    dashboard.addEventListener('click', (e) => {
        const reportBtn = e.target.closest('.report-btn');
        const voteBtn = e.target.closest('.vote-btn');
        if (reportBtn) {
            const requestId = reportBtn.dataset.id;
            reportRequestIdInput.value = requestId;
            toggleModal(reportReasonModal);
        } else if (voteBtn) {
            const requestId = voteBtn.dataset.id;
            const voteType = voteBtn.dataset.vote;
            handleVote(requestId, voteType);
        }
    });
    reportReasonForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('submit-report-btn');
        if (submitBtn.disabled) return;
        submitBtn.disabled = true;
        submitBtn.textContent = 'جاري الإرسال...';
        const requestId = reportRequestIdInput.value;
        const reason = reportReasonForm.elements.reason.value;
        const docRef = doc(db, 'donation_requests', requestId);
        try {
            await updateDoc(docRef, { reports: increment(1), reportReasons: arrayUnion(reason) });
            toggleModal(reportReasonModal);
            reportReasonForm.reset();
            document.getElementById('message-text').textContent = 'تم إرسال بلاغك بنجاح. سيتم مراجعته قريبًا. شكرًا لك.';
            document.getElementById('message-icon').className = 'fas fa-flag text-5xl text-amber-500 mb-4';
            toggleModal(messageModal);
        } catch (error) {
            console.error("Error submitting report: ", error);
            alert('حدث خطأ أثناء إرسال البلاغ.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'إرسال البلاغ';
        }
    });
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', (e) => toggleModal(e.target.closest('.modal')));
    });
    adminLoginBtn.addEventListener('click', () => {
        if (!sideBar.classList.contains('-right-full')) { toggleMenu(); }
        toggleModal(adminPasswordModal);
        adminPasswordInput.focus();
    });
    adminPasswordForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const enteredPassword = adminPasswordInput.value;
        const correctPassword = 'ADATSHIFAS22MARKETADMIN';
        if (enteredPassword === correctPassword) {
            window.location.href = 'dashboard.html';
        } else {
            adminPasswordError.classList.remove('hidden');
            adminPasswordInput.classList.add('border-red-500');
            adminPasswordForm.parentElement.classList.add('animate-shake');
            setTimeout(() => {
                adminPasswordError.classList.add('hidden');
                adminPasswordInput.classList.remove('border-red-500');
                adminPasswordInput.value = '';
                adminPasswordForm.parentElement.classList.remove('animate-shake');
            }, 2000);
        }
    });
    toggleAdminPasswordBtn.addEventListener('click', () => {
        const isPassword = adminPasswordInput.type === 'password';
        adminPasswordInput.type = isPassword ? 'text' : 'password';
        const icon = toggleAdminPasswordBtn.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
    });

    // --- Initialize Everything ---
    setupSoundActivation();
    fetchAndDisplayRequests();
    setInterval(updateTimestamps, 60000);
</script>
</body>
</html>