<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة شفاء للتبرع بالدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488; /* teal-600 */
            --secondary-color: #f43f5e; /* rose-500 */
            --bg-body: #f0fdfa; /* teal-50 */
        }
        body { font-family: 'Cairo', sans-serif; background-color: var(--bg-body); color: #1f2937; }
        .urgent { border-right: 5px solid var(--secondary-color); }
        .soon { border-right: 5px solid #f59e0b; }
        .later { border-right: 5px solid #10b981; }
        /* MODIFIED: Verified icon is now larger and more prominent */
        .verified::after {
            content: '✅';
            font-size: 1.2rem; /* Increased size */
            margin-right: 10px; /* Added some space */
            vertical-align: middle;
        }
        .custom-shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07); }
        .modal { transition: opacity 0.25s ease; }
        .modal-container { transition: transform 0.25s ease, opacity 0.25s ease; }
        .side-bar { transition: transform 0.3s ease-in-out; }
        .overlay.active { opacity: 1; visibility: visible; }
    </style>
</head>
<body class="antialiased">

    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 invisible transition-opacity duration-300"></div>

    <header class="bg-white/80 backdrop-blur-md custom-shadow-lg fixed top-0 right-0 left-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-3xl font-extrabold text-teal-600">أداة شفاء</a>
            <button id="menu-btn" class="fas fa-bars text-xl text-gray-600 cursor-pointer h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
        </div>
    </header>
    
    <aside id="side-bar" class="side-bar fixed top-0 -right-full w-80 h-full bg-white shadow-lg z-50 p-6 flex flex-col transform">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-teal-600">القائمة</h2>
            <button id="close-btn" class="fas fa-times text-2xl text-gray-500 cursor-pointer w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
        </div>
        <nav class="flex flex-col gap-3">
            <a href="#" id="sidebar-donor-btn" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-hand-holding-heart text-teal-500 w-6 text-center"></i><span>أريد التبرع</span></a>
            <a href="requests.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-list-alt text-teal-500 w-6 text-center"></i><span>تصفح الطلبات</span></a>
            <a href="centers.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-hospital text-teal-500 w-6 text-center"></i><span>أماكن التبرع</span></a>
            <a href="https://t.me/adatshifa" target="_blank" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-paper-plane text-teal-500 w-6 text-center"></i><span>تواصل معنا</span></a>
        </nav>
    </aside>

    <main class="container mx-auto px-4 sm:px-6 pt-24 sm:pt-28">
         <section class="text-center py-16 md:py-24">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mb-4 leading-tight">قطرة دم منك، حياة لغيرك</h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-10">منصة شفاء تربط بين المتبرعين بالدم والمحتاجين إليه بسهولة وسرعة. كن سبباً في إنقاذ حياة.</p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="open-donor-modal" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-hand-holding-heart mr-2"></i> أريد التبرع
                </button>
                <button id="open-request-modal" class="w-full sm:w-auto bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-bullhorn mr-2"></i> الإبلاغ عن حالة
                </button>
            </div>
        </section>

        <section class="pt-20 pb-10">
            <div class="flex justify-between items-center mb-8">
                 <h2 class="text-3xl md:text-4xl font-bold text-gray-800">أحدث الحالات</h2>
                 <a href="requests.html" class="bg-white hover:bg-gray-100 text-teal-600 font-bold py-2 px-5 rounded-full transition shadow-md hover:shadow-lg">
                    عرض الكل <i class="fas fa-arrow-left mr-2"></i>
                </a>
            </div>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 </div>
        </section>
    </main>
    
    <div id="request-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-lg mx-auto rounded-xl shadow-lg z-50 transform scale-95 opacity-0">
            <div class="py-4 px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">الإبلاغ عن حالة جديدة</p>
                    <button class="modal-close cursor-pointer z-50 text-3xl">&times;</button>
                </div>
                <div class="py-4 max-h-[70vh] overflow-y-auto">
                    <form id="donation-form" class="space-y-4">
                        <input type="text" id="hospital" placeholder="اسم المستشفى" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <select id="wilaya" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                            <option value="" disabled selected>اختر الولاية</option>
                        </select>
                        <input type="text" id="location" placeholder="المكان / المدينة" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <input type="tel" id="phone1" placeholder="رقم الهاتف الأساسي" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <select id="blood-type" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                            <option value="" disabled selected>اختر فصيلة الدم</option>
                            <option value="A+">A+</option> <option value="A-">A-</option>
                            <option value="B+">B+</option> <option value="B-">B-</option>
                            <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                            <option value="O+">O+</option> <option value="O-">O-</option>
                        </select>
                         <select id="urgency" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                                <option value="urgent">عاجل جداً</option>
                                <option value="soon">قريب</option>
                                <option value="later">غير مستعجل</option>
                         </select>
                         <textarea id="details" placeholder="تفاصيل الحالة / شكوى (اختياري)" rows="3" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"></textarea>
                        <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">إرسال البلاغ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
     <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4">
         <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 transform scale-95 opacity-0">
            <div class="py-6 px-6 text-center">
                <p id="modal-title" class="text-2xl font-bold mb-3"></p>
                <p id="modal-body" class="mb-5"></p>
                <button class="modal-close bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-8 rounded-lg">حسنًا</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, increment, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config remains the same
        const firebaseConfig = {
          apiKey: "AIzaSyBjGbfd-myjqLtqvdMp4b-h4LIaeZjfUto",
          authDomain: "altabarue-bialdam.firebaseapp.com",
          databaseURL: "https://altabarue-bialdam-default-rtdb.firebaseio.com",
          projectId: "altabarue-bialdam",
          storageBucket: "altabarue-bialdam.appspot.com",
          messagingSenderId: "1032387539358",
          appId: "1:1032387539358:web:229d33a9d5a0f522c9268f",
          measurementId: "G-GQ6M7F21PZ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const algerianWilayas = ["أدرار", "الشلف", "الأغواط", "أم البواقي", "باتنة", "بجاية", "بسكرة", "بشار", "البليدة", "البويرة","تمنراست", "تبسة", "تلمسان", "تيارت", "تيزي وزو", "الجزائر", "الجلفة", "جيجل", "سطيف", "سعيدة","سكيكدة", "سيدي بلعباس", "عنابة", "قالمة", "قسنطينة", "المدية", "مستغانم", "المسيلة", "معسكر", "ورقلة","وهران", "البيض", "إليزي", "برج بوعريريج", "بومرداس", "الطارف", "تندوف", "تيسمسيلت", "الوادي", "خنشلة","سوق أهراس", "تيبازة", "ميلة", "عين الدفلى", "النعامة", "عين تموشنت", "غرداية", "غليزان", "تيميمون","برج باجي مختار", "أولاد جلال", "بني عباس", "عين صالح", "عين قزام", "تقرت", "جانت", "المغير", "المنيعة"];
        const wilayaSelect = document.getElementById('wilaya');
        algerianWilayas.forEach(w => { wilayaSelect.innerHTML += `<option value="${w}">${w}</option>`; });

        const donationForm = document.getElementById('donation-form');
        const dashboard = document.getElementById('dashboard');

        // Modal and Sidebar management code remains the same
        const modals = document.querySelectorAll('.modal');
        const overlay = document.getElementById('overlay');
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.add('active');
                    modal.querySelector('.modal-container')?.classList.remove('scale-95', 'opacity-0');
                }, 10);
            }
        }
        function closeModal() {
            const activeModal = document.querySelector('.modal:not(.hidden)');
            if(activeModal) {
                 overlay.classList.remove('active');
                 activeModal.querySelector('.modal-container')?.classList.add('scale-95', 'opacity-0');
                 setTimeout(() => activeModal.classList.add('hidden'), 250);
            }
        }
        document.getElementById('open-request-modal').addEventListener('click', () => openModal('request-modal'));
        document.getElementById('open-donor-modal').addEventListener('click', () => openModal('donor-modal'));
        document.getElementById('sidebar-donor-btn').addEventListener('click', (e) => { e.preventDefault(); openModal('donor-modal'); closeSidebar(); });
        modals.forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay')) closeModal();
            });
        });
        const msgModal = {
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            show: (title, body) => {
                msgModal.title.textContent = title;
                msgModal.body.textContent = body;
                openModal('message-modal');
            }
        };
        const sideBar = document.getElementById('side-bar');
        const closeSidebar = () => {
             sideBar.classList.add('-right-full');
             sideBar.classList.remove('right-0');
             if(!document.querySelector('.modal:not(.hidden)')) overlay.classList.remove('active');
        };
        document.getElementById('menu-btn').addEventListener('click', () => { sideBar.classList.remove('-right-full'); sideBar.classList.add('right-0'); overlay.classList.add('active'); });
        document.getElementById('close-btn').addEventListener('click', closeSidebar);
        overlay.addEventListener('click', closeSidebar);


        // Firestore Logic
        const requestsCollection = collection(db, 'donation_requests');
        donationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(requestsCollection, {
                    hospital: donationForm.hospital.value,
                    wilaya: donationForm.wilaya.value,
                    location: donationForm.location.value,
                    phone1: donationForm.phone1.value,
                    bloodType: donationForm['blood-type'].value,
                    urgency: donationForm.urgency.value,
                    details: donationForm.details.value,
                    reports: 0,
                    verified: false,
                    createdAt: serverTimestamp()
                });
                donationForm.reset();
                closeModal();
                msgModal.show('تم بنجاح', 'شكراً لك، تم إرسال بلاغك وسيظهر للجميع بعد المراجعة.');
            } catch (error) {
                console.error("Error adding document: ", error);
                msgModal.show('خطأ', 'حدث خطأ غير متوقع.');
            }
        });

        const fetchAndDisplayRequests = () => {
            const q = query(requestsCollection, orderBy('createdAt', 'desc'), limit(6));
            onSnapshot(q, (querySnapshot) => {
                dashboard.innerHTML = '';
                if (querySnapshot.empty) {
                     dashboard.innerHTML = `<div class="text-center p-10 bg-white rounded-xl custom-shadow-lg md:col-span-3"><p class="text-gray-500 text-xl">لا توجد حالات حالياً.</p></div>`;
                    return;
                }
                querySnapshot.docs.forEach((doc) => {
                    const request = doc.data();
                    const card = document.createElement('div');
                    card.className = `bg-white p-5 rounded-xl custom-shadow-lg transition duration-300 transform hover:-translate-y-1 ${request.urgency}`;
                    
                    const date = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleDateString('ar-EG-u-nu-latn', { day: 'numeric', month: 'short', year: 'numeric' }) : 'غير متوفر';
                    let urgencyText, urgencyClass;
                    if(request.urgency === 'urgent') { urgencyText = 'عاجل جداً'; urgencyClass = 'bg-rose-100 text-rose-800'; }
                    else if(request.urgency === 'soon') { urgencyText = 'قريب'; urgencyClass = 'bg-amber-100 text-amber-800'; }
                    else { urgencyText = 'غير مستعجل'; urgencyClass = 'bg-green-100 text-green-800'; }

                    // MODIFIED: Card HTML now includes a report button
                    card.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                             <div>
                                <h3 class="text-xl font-bold text-gray-800 ${request.verified ? 'verified' : ''}">${request.hospital}</h3>
                                <p class="text-gray-600">${request.wilaya}, ${request.location}</p>
                             </div>
                             <div class="bg-rose-500 text-white font-bold text-2xl p-2 rounded-full w-16 h-16 flex items-center justify-center shadow-lg flex-shrink-0">${request.bloodType}</div>
                        </div>
                        <div class="my-4 border-t pt-4">
                            <p class="flex items-center gap-2 text-lg"><i class="fas fa-phone text-gray-400"></i><a href="tel:${request.phone1}" class="text-blue-600 hover:underline tracking-wider">${request.phone1}</a></p>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500 pt-3 border-t">
                             <p class="flex items-center gap-2"><i class="fas fa-calendar-alt"></i><span>${date}</span></p>
                             <button data-id="${doc.id}" class="report-btn bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-1 px-3 rounded-lg transition text-xs">
                                <i class="fas fa-flag"></i> إبلاغ
                            </button>
                        </div>
                    `;
                    dashboard.appendChild(card);
                });
            });
        };
        
        // NEW: Event listener for report buttons
        dashboard.addEventListener('click', async (e) => {
            const reportBtn = e.target.closest('.report-btn');
            if (reportBtn) {
                const docId = reportBtn.dataset.id;
                if (!docId) return;
                const docRef = doc(db, 'donation_requests', docId);
                 try {
                    await updateDoc(docRef, { reports: increment(1) });
                    msgModal.show('شكراً لك', 'تم تسجيل بلاغك بنجاح. سيقوم المسؤول بمراجعته.');
                } catch (error) {
                    console.error("Error reporting document: ", error);
                    msgModal.show('خطأ', 'لم نتمكن من تسجيل بلاغك.');
                }
            }
        });

        // Donor Quiz Logic remains the same
        fetchAndDisplayRequests();
    </script>
</body>
</html>