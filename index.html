<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>أداة شفاء للتبرع بالدم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488; /* teal-600 */
            --primary-dark: #0f766e; /* teal-700 */
            --secondary-color: #f43f5e; /* rose-500 */
            --bg-body: #f0fdfa; /* teal-50 */
            --bg-card: #ffffff;
            --text-primary: #1f2937; /* gray-800 */
            --text-secondary: #4b5563; /* gray-600 */
            --radius: 0.8rem;
        }
        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary);
        }
        .urgent { border-right: 5px solid var(--secondary-color); }
        .soon { border-right: 5px solid #f59e0b; }
        .later { border-right: 5px solid #10b981; }
        .verified::after {
            content: '✅';
            font-size: 1rem;
            margin-right: 8px;
            vertical-align: middle;
            animation: fadeIn 0.5s ease-in-out;
            display: inline-block;
        }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }
        
        /* Transitions for modals and sidebar */
        .modal { transition: opacity 0.25s ease; }
        .modal-container { transition: transform 0.25s ease, opacity 0.25s ease; }
        .side-bar { transition: transform 0.3s ease-in-out; }
        .overlay.active { opacity: 1; visibility: visible; }

        /* Custom shadow for a softer look */
        .custom-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .custom-shadow-lg {
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -4px rgba(0, 0, 0, 0.07);
        }
    </style>
</head>
<body class="antialiased">

    <div id="overlay" class="overlay fixed inset-0 bg-black bg-opacity-50 z-30 opacity-0 invisible transition-opacity duration-300"></div>

    <header class="bg-white/80 backdrop-blur-md custom-shadow-lg fixed top-0 right-0 left-0 z-40">
        <div class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="text-3xl font-extrabold text-teal-600">أداة شفاء</a>
            <div class="flex items-center gap-2 sm:gap-4">
                <a href="dashboard.html" class="hidden sm:inline-block text-sm font-semibold text-gray-600 hover:text-teal-600 transition-colors duration-300 bg-gray-100 hover:bg-teal-50 px-4 py-2 rounded-full">
                    <i class="fas fa-user-shield ml-1"></i>
                    دخول المشرف
                </a>
                <button id="menu-btn" class="fas fa-bars text-xl text-gray-600 cursor-pointer h-10 w-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
            </div>
        </div>
    </header>

    <aside id="side-bar" class="side-bar fixed top-0 -right-full w-80 h-full bg-white shadow-lg z-50 p-6 flex flex-col transform">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-bold text-teal-600">القائمة</h2>
            <button id="close-btn" class="fas fa-times text-2xl text-gray-500 cursor-pointer w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100"></button>
        </div>
        <nav class="flex flex-col gap-3">
            <a href="#" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-home text-teal-500 w-6 text-center"></i><span>الرئيسية</span></a>
            <a href="#" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors"><i class="fas fa-info-circle text-teal-500 w-6 text-center"></i><span>حول المنصة</span></a>
            <a href="dashboard.html" class="flex items-center gap-4 p-4 rounded-lg text-lg font-semibold hover:bg-teal-50 transition-colors sm:hidden"><i class="fas fa-user-shield text-teal-500 w-6 text-center"></i><span>دخول المشرف</span></a>
        </nav>
    </aside>

    <main class="container mx-auto px-4 sm:px-6 pt-24 sm:pt-28">

        <section class="text-center py-16 md:py-24">
            <h1 class="text-4xl md:text-6xl font-extrabold text-gray-800 mb-4 leading-tight">قطرة دم منك، حياة لغيرك</h1>
            <p class="text-lg md:text-xl text-gray-600 max-w-3xl mx-auto mb-10">
                منصة شفاء تربط بين المتبرعين بالدم والمحتاجين إليه بسهولة وسرعة. كن سبباً في إنقاذ حياة.
            </p>
            <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                <button id="open-donor-modal" class="w-full sm:w-auto bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-hand-holding-heart mr-2"></i> أريد التبرع
                </button>
                <button id="open-request-modal" class="w-full sm:w-auto bg-rose-500 hover:bg-rose-600 text-white font-bold py-4 px-8 rounded-lg transition text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    <i class="fas fa-bullhorn mr-2"></i> أحتاج إلى دم
                </button>
            </div>
        </section>

        <section class="py-16 bg-white rounded-2xl custom-shadow-lg px-6 md:px-10">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-800">فضل إنقاذ حياة في ديننا الحنيف</h2>
                <p class="text-md text-gray-500 mt-2">آيات وأحاديث تحث على فعل الخير وإغاثة الملهوف.</p>
            </div>
            <div class="space-y-10 max-w-4xl mx-auto">
                <article class="p-6 bg-teal-50/50 border-r-4 border-teal-600 rounded-lg">
                    <p class="text-sm text-gray-600 mb-2">بسم الله الرحمن الرحيم</p>
                    <blockquote class="mb-4">
                        <p class="text-xl md:text-2xl leading-relaxed font-serif text-gray-800">

﴿ مِنْ أَجْلِ ذَٰلِكَ كَتَبْنَا عَلَىٰ بَنِي إِسْرَائِيلَ أَنَّهُ مَن قَتَلَ نَفْسًا بِغَيْرِ نَفْسٍ أَوْ فَسَادٍ فِي الْأَرْضِ فَكَأَنَّمَا قَتَلَ النَّاسَ جَمِيعًا وَمَنْ أَحْيَاهَا فَكَأَنَّمَا أَحْيَا النَّاسَ جَمِيعًا ۚ وَلَقَدْ جَاءَتْهُمْ رُسُلُنَا بِالْبَيِّنَاتِ ثُمَّ إِنَّ كَثِيرًا مِّنْهُم بَعْدَ ذَٰلِكَ فِي الْأَرْضِ لَمُسْرِفُونَ﴾

                            <span class="block text-base font-sans mt-3 text-gray-600">[ المائدة: 32]</span>
                        </p>
                    </blockquote>
                    <footer class="text-left text-xs text-gray-500">
                        <p>المصدر: <a href="https://surahquran.com/aya-32-sora-5.html" class="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">surahquran.com</a></p>
                    </footer>
                </article>

                <article class="p-6 bg-sky-50/50 border-r-4 border-sky-600 rounded-lg">
                    <blockquote>
                        <p class="text-lg md:text-xl leading-loose text-gray-800">
﻿
مَن نَفَّسَ عن مُؤْمِنٍ كُرْبَةً مِن كُرَبِ الدُّنْيَا، نَفَّسَ اللَّهُ عنْه كُرْبَةً مِن كُرَبِ يَومِ القِيَامَةِ، وَمَن يَسَّرَ علَى مُعْسِرٍ، يَسَّرَ اللَّهُ عليه في الدُّنْيَا وَالآخِرَةِ، وَمَن سَتَرَ مُسْلِمًا، سَتَرَهُ اللَّهُ في الدُّنْيَا وَالآخِرَةِ، وَاللَّهُ في عَوْنِ العَبْدِ ما كانَ العَبْدُ في عَوْنِ أَخِيهِ، وَمَن سَلَكَ طَرِيقًا يَلْتَمِسُ فيه عِلْمًا، سَهَّلَ اللَّهُ له به طَرِيقًا إلى الجَنَّةِ، وَما اجْتَمع قَوْمٌ في بَيْتٍ مِن بُيُوتِ اللهِ، يَتْلُونَ كِتَابَ اللهِ، وَيَتَدَارَسُونَهُ بيْنَهُمْ؛ إِلَّا نَزَلَتْ عليهمِ السَّكِينَةُ، وَغَشِيَتْهُمُ الرَّحْمَةُ، وَحَفَّتْهُمُ المَلَائِكَةُ، وَذَكَرَهُمُ اللَّهُ فِيمَن عِنْدَهُ، وَمَن بَطَّأَ به عَمَلُهُ، لَمْ يُسْرِعْ به نَسَبُهُ.                        </p>
                    </blockquote>
                    <footer class="text-sm text-gray-600 mt-4 pt-4 border-t border-sky-200 space-y-1">
                        <p><strong>الراوي:</strong> أبو هريرة | <strong>المحدث:</strong> مسلم | <strong>المصدر:</strong> صحيح مسلم | <strong>الرقم:</strong> 2699</p>
                        <p>المصدر: <a href="https://dorar.net/hadith/sharh/20512" class="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">dorar.net</a></p>
                    </footer>
                </article>

                <article class="p-6 bg-amber-50/50 border-r-4 border-amber-500 rounded-lg">
                    <blockquote>
                        <p class="text-lg md:text-xl leading-loose text-gray-800">
﻿
أنَّ رَسولَ اللَّهِ صَلَّى اللهُ عليه وسلَّمَ قالَ: بَيْنا رَجُلٌ يَمْشِي، فاشْتَدَّ عليه العَطَشُ، فَنَزَلَ بئْرًا، فَشَرِبَ مِنْها، ثُمَّ خَرَجَ فإذا هو بكَلْبٍ يَلْهَثُ يَأْكُلُ الثَّرَى مِنَ العَطَشِ، فقالَ: لقَدْ بَلَغَ هذا مِثْلُ الذي بَلَغَ بي، فَمَلَأَ خُفَّهُ، ثُمَّ أمْسَكَهُ بفِيهِ، ثُمَّ رَقِيَ، فَسَقَى الكَلْبَ، فَشَكَرَ اللَّهُ له، فَغَفَرَ له، قالوا: يا رَسولَ اللَّهِ، وإنَّ لنا في البَهائِمِ أجْرًا؟ قالَ: في كُلِّ كَبِدٍ رَطْبَةٍ أجْرٌ.
                        </p>
                    </blockquote>
                    <footer class="text-sm text-gray-600 mt-4 pt-4 border-t border-amber-200 space-y-1">
                        <p><strong>الراوي:</strong> أبو هريرة | <strong>المحدث:</strong> البخاري | <strong>المصدر:</strong> صحيح البخاري | <strong>الرقم:</strong> 2363</p>
                         <p>المصدر: <a href="https://dorar.net/hadith/sharh/6627" class="text-blue-600 hover:underline" target="_blank" rel="noopener noreferrer">dorar.net</a></p>
                    </footer>
                </article>
            </div>
        </section>

        <section class="pt-20 pb-10">
            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center text-gray-800">الطلبات الحالية</h2>
            <div id="dashboard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                 </div>
        </section>

    </main>

    <footer class="bg-white mt-12 py-10 border-t">
        <div class="container mx-auto px-4 text-center text-gray-600">
            <p class="font-bold text-lg mb-4 text-teal-700">تابع أداة شفاء</p>
            <div class="flex justify-center items-center gap-6 mb-6">
                <a href="https://t.me/adatshifa" target="_blank" class="text-2xl hover:text-teal-600 transition-colors"><i class="fab fa-telegram"></i></a>
                <a href="https://www.facebook.com/profile.php?id=100088258380231" target="_blank" class="text-2xl hover:text-teal-600 transition-colors"><i class="fab fa-facebook"></i></a>
                <a href="https://www.instagram.com/adat_shifa?igsh=MXBsc2xveGtlZzM5ZA==" target="_blank" class="text-2xl hover:text-teal-600 transition-colors"><i class="fab fa-instagram"></i></a>
            </div>
            <p class="text-sm">&copy; 2024 أداة شفاء. جميع الحقوق محفوظة.</p>
        </div>
    </footer>
    
    <div id="request-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-lg mx-auto rounded-xl shadow-lg z-50 transform scale-95 opacity-0">
            <div class="py-4 px-6">
                <div class="flex justify-between items-center pb-3 border-b">
                    <p class="text-2xl font-bold">إضافة طلب تبرع جديد</p>
                    <button class="modal-close cursor-pointer z-50 text-3xl">&times;</button>
                </div>
                <div class="py-4 max-h-[70vh] overflow-y-auto">
                    <form id="donation-form" class="space-y-4">
                        <input type="text" id="hospital" placeholder="اسم المستشفى" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <select id="wilaya" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                            <option value="" disabled selected>اختر الولاية</option>
                        </select>
                        <input type="text" id="location" placeholder="المكان / المدينة" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <input type="tel" id="phone1" placeholder="رقم الهاتف الأساسي" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                        <select id="blood-type" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                            <option value="" disabled selected>اختر فصيلة الدم</option>
                            <option value="A+">A+</option> <option value="A-">A-</option>
                            <option value="B+">B+</option> <option value="B-">B-</option>
                            <option value="AB+">AB+</option> <option value="AB-">AB-</option>
                            <option value="O+">O+</option> <option value="O-">O-</option>
                        </select>
                         <select id="urgency" class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 bg-white" required>
                                <option value="urgent">عاجل جداً</option>
                                <option value="soon">قريب</option>
                                <option value="later">غير مستعجل</option>
                         </select>
                        <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">إرسال الطلب</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="donor-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4">
        <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-full max-w-lg mx-auto rounded-xl shadow-lg z-50 transform scale-95 opacity-0">
            <div id="quiz-container">
                 <div class="py-4 px-6">
                    <div class="flex justify-between items-center pb-3 border-b">
                        <p class="text-2xl font-bold">اختبار أهلية التبرع</p>
                        <button class="modal-close cursor-pointer z-50 text-3xl">&times;</button>
                    </div>
                    <div class="py-4 space-y-5">
                        <div class="quiz-question">
                            <p class="font-semibold mb-2">1. هل عمرك بين 18 و 65 عاماً؟</p>
                            <div class="flex gap-4"><label><input type="radio" name="q1" value="yes" class="mr-1"> نعم</label><label><input type="radio" name="q1" value="no" class="mr-1"> لا</label></div>
                        </div>
                        <div class="quiz-question">
                            <p class="font-semibold mb-2">2. هل وزنك 50 كجم أو أكثر؟</p>
                            <div class="flex gap-4"><label><input type="radio" name="q2" value="yes" class="mr-1"> نعم</label><label><input type="radio" name="q2" value="no" class="mr-1"> لا</label></div>
                        </div>
                        <div class="quiz-question">
                            <p class="font-semibold mb-2">3. هل تبرعت بالدم خلال الأشهر الثلاثة الماضية؟</p>
                            <div class="flex gap-4"><label><input type="radio" name="q3" value="no" class="mr-1"> نعم</label><label><input type="radio" name="q3" value="yes" class="mr-1"> لا</label></div>
                        </div>
                         <p id="quiz-error" class="text-red-500 text-sm hidden">الرجاء الإجابة على جميع الأسئلة.</p>
                        <button id="check-eligibility" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-bold py-3 px-4 rounded-lg transition text-lg">تحقق من الأهلية</button>
                    </div>
                </div>
            </div>
            <div id="result-container" class="hidden p-6 text-center">
                <p id="eligibility-result" class="text-2xl font-bold mb-4"></p>
                <p id="eligibility-message" class="text-gray-600 mb-6"></p>
                <button class="modal-close w-full sm:w-auto bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">إغلاق</button>
            </div>
        </div>
    </div>

    <div id="message-modal" class="modal fixed inset-0 flex items-center justify-center hidden z-50 p-4">
         <div class="modal-overlay absolute inset-0 bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 transform scale-95 opacity-0">
            <div class="py-6 px-6 text-center">
                <p id="modal-title" class="text-2xl font-bold mb-3"></p>
                <p id="modal-body" class="mb-5"></p>
                <button class="modal-close bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-8 rounded-lg">حسنًا</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBjGbfd-myjqLtqvdMp4b-h4LIaeZjfUto",
          authDomain: "altabarue-bialdam.firebaseapp.com",
          databaseURL: "https://altabarue-bialdam-default-rtdb.firebaseio.com",
          projectId: "altabarue-bialdam",
          storageBucket: "altabarue-bialdam.appspot.com",
          messagingSenderId: "1032387539358",
          appId: "1:1032387539358:web:229d33a9d5a0f522c9268f",
          measurementId: "G-GQ6M7F21PZ"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const algerianWilayas = ["أدرار", "الشلف", "الأغواط", "أم البواقي", "باتنة", "بجاية", "بسكرة", "بشار", "البليدة", "البويرة","تمنراست", "تبسة", "تلمسان", "تيارت", "تيزي وزو", "الجزائر", "الجلفة", "جيجل", "سطيف", "سعيدة","سكيكدة", "سيدي بلعباس", "عنابة", "قالمة", "قسنطينة", "المدية", "مستغانم", "المسيلة", "معسكر", "ورقلة","وهران", "البيض", "إليزي", "برج بوعريريج", "بومرداس", "الطارف", "تندوف", "تيسمسيلت", "الوادي", "خنشلة","سوق أهراس", "تيبازة", "ميلة", "عين الدفلى", "النعامة", "عين تموشنت", "غرداية", "غليزان", "تيميمون","برج باجي مختار", "أولاد جلال", "بني عباس", "عين صالح", "عين قزام", "تقرت", "جانت", "المغير", "المنيعة"];
        const wilayaSelect = document.getElementById('wilaya');
        algerianWilayas.forEach(w => { wilayaSelect.innerHTML += `<option value="${w}">${w}</option>`; });

        const donationForm = document.getElementById('donation-form');
        const dashboard = document.getElementById('dashboard');

        // Modal Management
        const modals = document.querySelectorAll('.modal');
        const overlay = document.getElementById('overlay');
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if(modal) {
                modal.classList.remove('hidden');
                const modalContainer = modal.querySelector('.modal-container');
                setTimeout(() => {
                    overlay.classList.add('active');
                    if (modalContainer) {
                        modalContainer.classList.remove('scale-95', 'opacity-0');
                    }
                }, 10);
            }
        }
        function closeModal() {
            const activeModal = document.querySelector('.modal:not(.hidden)');
            if(activeModal) {
                 overlay.classList.remove('active');
                 const modalContainer = activeModal.querySelector('.modal-container');
                 if (modalContainer) {
                    modalContainer.classList.add('scale-95', 'opacity-0');
                 }
                 setTimeout(() => activeModal.classList.add('hidden'), 250);
            }
        }
        document.getElementById('open-request-modal').addEventListener('click', () => openModal('request-modal'));
        document.getElementById('open-donor-modal').addEventListener('click', () => openModal('donor-modal'));
        modals.forEach(modal => {
            modal.addEventListener('click', e => {
                if (e.target.classList.contains('modal-close') || e.target.classList.contains('modal-overlay')) {
                    closeModal();
                }
            });
        });
        const msgModal = {
            title: document.getElementById('modal-title'),
            body: document.getElementById('modal-body'),
            show: (title, body) => {
                msgModal.title.textContent = title;
                msgModal.body.textContent = body;
                openModal('message-modal');
            }
        };

        // Sidebar Management
        const sideBar = document.getElementById('side-bar');
        document.getElementById('menu-btn').addEventListener('click', () => {
             sideBar.classList.remove('-right-full');
             sideBar.classList.add('right-0');
             overlay.classList.add('active');
        });
        const closeSidebar = () => {
             sideBar.classList.add('-right-full');
             sideBar.classList.remove('right-0');
             if(!document.querySelector('.modal:not(.hidden)')) {
                overlay.classList.remove('active');
             }
        };
        document.getElementById('close-btn').addEventListener('click', closeSidebar);
        overlay.addEventListener('click', closeSidebar);

        // --- Firestore Logic ---
        const requestsCollection = collection(db, 'donation_requests');

        donationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(requestsCollection, {
                    hospital: donationForm.hospital.value,
                    wilaya: donationForm.wilaya.value,
                    location: donationForm.location.value,
                    phone1: donationForm.phone1.value,
                    bloodType: donationForm['blood-type'].value,
                    urgency: donationForm.urgency.value,
                    reports: 0,
                    verified: false,
                    createdAt: serverTimestamp()
                });
                donationForm.reset();
                closeModal();
                msgModal.show('تم بنجاح', 'شكراً لك، تم نشر طلبك مباشرة وسيظهر للجميع.');
            } catch (error) {
                console.error("Error adding document: ", error);
                msgModal.show('خطأ', 'حدث خطأ غير متوقع أثناء إضافة الطلب.');
            }
        });

        const fetchAndDisplayRequests = () => {
            const q = query(requestsCollection);
            onSnapshot(q, (querySnapshot) => {
                dashboard.innerHTML = '';
                if (querySnapshot.empty) {
                     dashboard.innerHTML = `<div class="text-center p-10 bg-white rounded-xl custom-shadow-lg md:col-span-2 lg:col-span-3"><p class="text-gray-500 text-xl">لا توجد طلبات حالياً. كن أول من يضيف طلباً!</p></div>`;
                    return;
                }
                querySnapshot.docs
                  .sort((a, b) => b.data().createdAt?.toMillis() - a.data().createdAt?.toMillis())
                  .forEach((doc) => {
                    const request = doc.data();
                    const card = document.createElement('div');
                    card.className = `bg-white p-5 rounded-xl custom-shadow-lg transition duration-300 transform hover:-translate-y-1 ${request.urgency}`;
                    
                    const date = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleDateString('ar-EG', { year: 'numeric', month: 'short', day: 'numeric' }) : 'غير متوفر';
                    let urgencyText, urgencyClass;
                    if(request.urgency === 'urgent') { urgencyText = 'عاجل جداً'; urgencyClass = 'bg-rose-100 text-rose-800'; }
                    else if(request.urgency === 'soon') { urgencyText = 'قريب'; urgencyClass = 'bg-amber-100 text-amber-800'; }
                    else { urgencyText = 'غير مستعجل'; urgencyClass = 'bg-green-100 text-green-800'; }

                    card.innerHTML = `
                        <div class="flex justify-between items-start gap-4">
                             <div>
                                <h3 class="text-xl font-bold text-gray-800 ${request.verified ? 'verified' : ''}">${request.hospital}</h3>
                                <p class="text-gray-600">${request.wilaya}, ${request.location}</p>
                             </div>
                             <div class="bg-rose-500 text-white font-bold text-2xl p-2 rounded-full w-16 h-16 flex items-center justify-center shadow-lg flex-shrink-0">${request.bloodType}</div>
                        </div>
                        <div class="my-4 border-t pt-4 space-y-3">
                            <p class="flex items-center gap-2"><i class="fas fa-phone text-gray-400"></i><strong class="font-semibold">الهاتف:</strong> <a href="tel:${request.phone1}" class="text-blue-600 hover:underline tracking-wider">${request.phone1}</a></p>
                            <p class="flex items-center gap-2"><i class="fas fa-exclamation-circle text-gray-400"></i><strong class="font-semibold">الاستعجال:</strong> <span class="text-sm font-semibold px-3 py-1 rounded-full ${urgencyClass}">${urgencyText}</span></p>
                        </div>
                        <div class="flex justify-between items-center text-sm text-gray-500 pt-3 border-t">
                             <p class="flex items-center gap-2"><i class="fas fa-calendar-alt"></i><span>أضيف بتاريخ: ${date}</span></p>
                            <button data-id="${doc.id}" class="report-btn bg-amber-100 hover:bg-amber-200 text-amber-800 font-bold py-1 px-3 rounded-lg transition text-xs">
                                <i class="fas fa-flag"></i> إبلاغ
                            </button>
                        </div>
                    `;
                    dashboard.appendChild(card);
                });
            });
        };

        dashboard.addEventListener('click', async (e) => {
            const reportBtn = e.target.closest('.report-btn');
            if (reportBtn) {
                const docId = reportBtn.dataset.id;
                if (!docId) return;
                const docRef = doc(db, 'donation_requests', docId);
                 try {
                    await updateDoc(docRef, { reports: increment(1) });
                    msgModal.show('شكراً لك', 'تم تسجيل بلاغك بنجاح.');
                } catch (error) {
                    console.error("Error reporting document: ", error);
                }
            }
        });
        
        // Donor Quiz Logic
        document.getElementById('check-eligibility').addEventListener('click', () => {
            const q1 = document.querySelector('input[name="q1"]:checked'), q2 = document.querySelector('input[name="q2"]:checked'), q3 = document.querySelector('input[name="q3"]:checked');
            const errorP = document.getElementById('quiz-error');
            if(!q1 || !q2 || !q3) { errorP.classList.remove('hidden'); return; }
            errorP.classList.add('hidden');
            const isEligible = q1.value === 'yes' && q2.value === 'yes' && q3.value === 'yes';
            document.getElementById('quiz-container').classList.add('hidden');
            const resultContainer = document.getElementById('result-container');
            resultContainer.classList.remove('hidden');
            const resultText = document.getElementById('eligibility-result'), resultMsg = document.getElementById('eligibility-message');
            if (isEligible) {
                resultText.textContent = '✅ أنت مؤهل للتبرع!'; resultText.className = "text-2xl font-bold mb-4 text-green-600";
                resultMsg.textContent = 'شكراً لك على استعدادك للمساعدة. تبرعك يمكن أن ينقذ حياة.';
            } else {
                resultText.textContent = '❌ عذراً، أنت غير مؤهل حالياً.'; resultText.className = "text-2xl font-bold mb-4 text-red-600";
                resultMsg.textContent = 'قد تكون هناك شروط أخرى تمنعك من التبرع. يرجى استشارة مختص طبي لمزيد من المعلومات.';
            }
        });
        document.getElementById('open-donor-modal').addEventListener('click', () => {
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('result-container').classList.add('hidden');
            document.querySelectorAll('.quiz-question input[type="radio"]').forEach(radio => radio.checked = false);
        });

        fetchAndDisplayRequests();
    </script>
</body>
</html>